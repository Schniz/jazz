import { ContentByFramework, CodeGroup } from '@/components/forMdx'
import { Alert } from "gcmp-design-system/src/app/components/atoms/Alert";

export const metadata = { title: "Upgrade to Jazz 0.11.0" };

# Jazz 0.11.0 is out!

Jazz 0.11.0 brings several improvements to member handling, roles, and permissions management. This guide will help you upgrade your application to the latest version.

## New Features


### Account Profile & Migrations

We fixed a bug where custom accounts profiles could not be migrated.
You can now provide your own Profile type and have it correctly migrate through schema changes.

<CodeGroup>
```ts
export class MyAppAccount extends Account {
  profile = co.ref(MyAppProfile);

  override async migrate() {
    if (this.profile === undefined) {
      const profileGroup = Group.create();
      profileGroup.addMember("everyone", "reader");

      this.profile = MyAppProfile.create({
        name: "John Doe",
      }, profileGroup);
    }
  }
}
```
</CodeGroup>

<Alert variant="warning" title="Warning" className="mt-4">
If you provide a custom `Profile` in your `Account` schema and migration for a Worker account, 
make sure to also add  `everyone` as member with `reader` role to the owning group. 
Failing to do so will prevent any account from sending messages to the Worker's Inbox.
</Alert>


### Enhanced Permission Management

New methods have been added to both `Account` and `Group` classes to improve permission handling:

#### Permission checks

The new `canRead`, `canWrite` and `canAdmin` methods on `Account` allow you to easily check if the account has specific permissions on a CoValue:

<CodeGroup>
{/* prettier-ignore */}
```typescript
const me = Account.getMe();

if (me.canAdmin(value)) {
  console.log("I can share value with others"); 
} else if (me.canWrite(value)) {
  console.log("I can edit value");
} else if (me.canRead(value)) {
  console.log("I can view value");
} else {
  console.log("I cannot access value");
}
```
</CodeGroup>

#### Getting the role of an account

The `getRoleOf` method has been added to query the role of specific entities:

<CodeGroup>
```typescript
const group = Group.create();
group.getRoleOf(me); // admin
group.getRoleOf(Eve); // undefined

group.addMember(Eve, "writer");
group.getRoleOf(Eve); // writer
```
</CodeGroup>

## Breaking Changes

### Member Inheritance Changes

The behavior of groups' `members` getter method has been updated to return both direct members and inherited ones from acestor froups. 
This might affect your application if you were relying on only direct members being returned.

<CodeGroup>
```ts
/**
 *  The following pseudocode only illustrates the inheritance logic, 
 *  the actual implementation is different.
*/

const parentGroup = Group.create();
parentGroup.addMember(John, "admin");

const childGroup = Group.create();
childGroup.addMember(Eve, "admin");

childGroup.extend(parentGroup);

console.log(childGroup.members);
// Before 0.11.0
// [Eve]

// After 0.11.0
// [Eve, John]
```
</CodeGroup>

#### Migration Steps

1. Review your member querying logic to account for inherited members.
2. Update your permission checking code to utilize the new [`hasPermissions` and `getRoleOf`](#enhanced-permission-management) methods.
4. Consider implementing `"everyone"` role checks where appropriate.

### Dropped support for Accounts owning Profiles

Starting from `0.11.0` `Profile`s can only be owned by `Group`s.

#### Migration Steps

If you previously forced a migration of your `Account` schema to include a custom `Profile`, 
and assigned its ownership to an `Account`, you need to recreate your profile code and assign it to a `Group` instead.

<CodeGroup>
```ts
export class MyAppAccount extends Account {
  profile = co.ref(MyAppProfile);

  override async migrate() {
    // ...

    const me = await this.ensureLoaded({
      profile: {},
    });

    if ((me.profile._owner as Group | Account)._type === "Account") {
      const profileGroup = Group.create();
      profileGroup.addMember("everyone", "reader");

      // recreate your profile here...
      me.profile = Profile.create(
        {
          name: me.profile.name,
        },
        profileGroup,
      );
    }
  }
}
```
</CodeGroup>

<Alert variant="info" title="Note" className="mt-4">
Existing profiles owned by `Account`s will still work, but you will get incorrect types when accessing a `Profile`'s `_owner`.
</Alert>

### Removed auto-update of `profile.name` in `usePasskeyAuth`

The `usePasskeyAuth` hook now doesn't update the `profile.name` if the provided username is empty.

